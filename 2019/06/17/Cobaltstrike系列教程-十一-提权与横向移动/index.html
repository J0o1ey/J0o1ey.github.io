<!DOCTYPE html><html class="appearance-auto" lang="cn"><head><meta charset="UTF-8"><title>Cobaltstrike系列教程(十一)提权与横向移动</title><meta name="description" content="J0o1ey Blog | Hack for Sec and Good"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?" + '1da71ad199e154beef984da705235690';
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();</script><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="0x001-提权1.右键菜单提权:选择beacon，右键，执行–&amp;gt;提权我由于加载了插件，所以比官方多了几种提权方式插件下载请看我之前的帖子
ms14-058&amp;#x2F;ms15-051&amp;#x2F;ms16-016&amp;#x2F;ms16-032这些都是大家耳熟能详的Windows本地提权漏洞，在此插件中都已经集成
UAC-DLL这是一种绕过UAC的攻击，它试图将本地管理员运行的有效负载从低权限提升到高权限。此攻击使用UAC漏洞将ArtifactKit生成的DLL复制到特权位置。此攻击适用于Windows7和Windows8及更高版本的未修补版本。
uac-token-duplication这是另一种绕过UAC的攻击，将其从低权限提升到高权限（作为本地管理员）。这种攻击使用一个UAC漏洞，允许非提升进程使用.."><meta name="generator" content="Hexo 6.3.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">J0o1ey's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Cobaltstrike系列教程(十一)提权与横向移动</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x001-%E6%8F%90%E6%9D%83"><span class="toc-text">0x001-提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E6%8F%90%E6%9D%83"><span class="toc-text">1.右键菜单提权:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ms14-058-x2F-ms15-051-x2F-ms16-016-x2F-ms16-032"><span class="toc-text">ms14-058&#x2F;ms15-051&#x2F;ms16-016&#x2F;ms16-032</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UAC-DLL"><span class="toc-text">UAC-DLL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uac-token-duplication"><span class="toc-text">uac-token-duplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Uac-eventvwr"><span class="toc-text">Uac-eventvwr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Uac-wscript"><span class="toc-text">Uac-wscript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%87%AA%E7%94%A8EXP%E6%8F%90%E6%9D%83"><span class="toc-text">2.自用EXP提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Powershell%E6%8F%90%E6%9D%83"><span class="toc-text">3.Powershell提权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x002-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-text">0x002-横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F%E6%A6%82%E5%BF%B5"><span class="toc-text">横向渗透概念:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Psexec%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-text">1.Psexec横向移动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%AA%83%E5%8F%96%E4%BB%A4%E7%89%8C"><span class="toc-text">2.窃取令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%85%B6%E4%BB%96%E6%89%8B%E6%AE%B5%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-text">3.其他手段横向移动</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7"><i class="tag post-item-tag">安全工具</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Cobaltstrike系列教程(十一)提权与横向移动</h1><time class="has-text-grey" datetime="2019-06-17T11:32:14.000Z">2019-06-17</time><article class="mt-2 post-content"><h2 id="0x001-提权"><a href="#0x001-提权" class="headerlink" title="0x001-提权"></a>0x001-提权</h2><h3 id="1-右键菜单提权"><a href="#1-右键菜单提权" class="headerlink" title="1.右键菜单提权:"></a>1.右键菜单提权:</h3><p>选择beacon，右键，执行–&gt;提权<br><img src="https://s2.ax1x.com/2019/07/29/e1wAFP.png" alt="e1wAFP.png"><br>我由于加载了插件，所以比官方多了几种提权方式<br>插件下载请看我之前的帖子<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1dbZR"><img src="https://s2.ax1x.com/2019/07/29/e1dbZR.png" alt="e1dbZR.png"></a></p>
<h3 id="ms14-058-x2F-ms15-051-x2F-ms16-016-x2F-ms16-032"><a href="#ms14-058-x2F-ms15-051-x2F-ms16-016-x2F-ms16-032" class="headerlink" title="ms14-058&#x2F;ms15-051&#x2F;ms16-016&#x2F;ms16-032"></a>ms14-058&#x2F;ms15-051&#x2F;ms16-016&#x2F;ms16-032</h3><p>这些都是大家耳熟能详的Windows本地提权漏洞，在此插件中都已经集成</p>
<h3 id="UAC-DLL"><a href="#UAC-DLL" class="headerlink" title="UAC-DLL"></a>UAC-DLL</h3><p>这是一种绕过UAC的攻击，它试图将本地管理员运行的有效负载从低权限提升到高权限。此攻击使用UAC漏洞将ArtifactKit生成的DLL复制到特权位置。此攻击适用于Windows7和Windows8及更高版本的未修补版本。</p>
<h3 id="uac-token-duplication"><a href="#uac-token-duplication" class="headerlink" title="uac-token-duplication"></a>uac-token-duplication</h3><p>这是另一种绕过UAC的攻击，将其从低权限提升到高权限（作为本地管理员）。这种攻击使用一个UAC漏洞，允许非提升进程使用从提升进程中窃取的令牌启动任意进程。此漏洞要求攻击删除分配给提升令牌的多个权限。此攻击适用于Windows7及更高版本。如果AlwaysNotify处于其最高设置，则此攻击要求提升的进程已在当前桌面会话中运行（作为同一用户）,此漏洞使用PowerShell生成会话。</p>
<h3 id="Uac-eventvwr"><a href="#Uac-eventvwr" class="headerlink" title="Uac-eventvwr"></a>Uac-eventvwr</h3><p>这种提权方法是利用时间查看器eventvwr，通过注册表之后，执行Eventvwr.exe会自动加载我们的A.exe(exp),这个时候他的权限就是高了，成功绕过UAV<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1dLIx"><img src="https://s2.ax1x.com/2019/07/29/e1dLIx.png" alt="e1dLIx.png"></a></p>
<h3 id="Uac-wscript"><a href="#Uac-wscript" class="headerlink" title="Uac-wscript"></a>Uac-wscript</h3><p>这种绕过uac提权的方法最初是在Empire框架中现身的，该方法只针对Windows7有效</p>
<h3 id="2-自用EXP提权"><a href="#2-自用EXP提权" class="headerlink" title="2.自用EXP提权"></a>2.自用EXP提权</h3><p>这种方式就是比较常规的方法，自己上传最新的EXP进行提权，至于文件上传和执行的方法，之前已经讲过，在此不多赘述<br>最近测试CVE-2019-0803的提权效果不错，影响版本非常广</p>
<pre><code>Microsoft Windows Server 2019 0
Microsoft Windows Server 2016 0
Microsoft Windows Server 2012 R2 0
Microsoft Windows Server 2012 0
Microsoft Windows Server 2008 R2 for x64-based Systems SP1
Microsoft Windows Server 2008 R2 for Itanium-based Systems SP1
Microsoft Windows Server 2008 for x64-based Systems SP2
Microsoft Windows Server 2008 for Itanium-based Systems SP2
Microsoft Windows Server 2008 for 32-bit Systems SP2
Microsoft Windows Server 1803 0
Microsoft Windows Server 1709 0
Microsoft Windows RT 8.1
Microsoft Windows 8.1 for x64-based Systems 0
Microsoft Windows 8.1 for 32-bit Systems 0
Microsoft Windows 7 for x64-based Systems SP1
Microsoft Windows 7 for 32-bit Systems SP1
Microsoft Windows 10 Version 1809 for x64-based Systems 0
Microsoft Windows 10 Version 1809 for ARM64-based Systems 0
Microsoft Windows 10 Version 1809 for 32-bit Systems 0
Microsoft Windows 10 Version 1803 for x64-based Systems 0
Microsoft Windows 10 Version 1803 for ARM64-based Systems 0
Microsoft Windows 10 Version 1803 for 32-bit Systems 0
Microsoft Windows 10 version 1709 for x64-based Systems 0
Microsoft Windows 10 Version 1709 for ARM64-based Systems 0
Microsoft Windows 10 version 1709 for 32-bit Systems 0
Microsoft Windows 10 version 1703 for x64-based Systems 0
Microsoft Windows 10 version 1703 for 32-bit Systems 0
Microsoft Windows 10 Version 1607 for x64-based Systems 0
Microsoft Windows 10 Version 1607 for 32-bit Systems 0
Microsoft Windows 10 for x64-based Systems 0
Microsoft Windows 10 for 32-bit Systems 0
</code></pre>
<p>EXP的下载链接为:<a target="_blank" rel="noopener" href="https://github.com/k8gege/K8tools/raw/master/CVE-2019-0803.exe">https://github.com/k8gege/K8tools/raw/master/CVE-2019-0803.exe</a><br>用法:CVE-2019-0803.exe cmd cmdline，可能需要多执行几次才可以成功<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1dqd1"><img src="https://s2.ax1x.com/2019/07/29/e1dqd1.png" alt="e1dqd1.png"></a></p>
<h3 id="3-Powershell提权"><a href="#3-Powershell提权" class="headerlink" title="3.Powershell提权"></a>3.Powershell提权</h3><p>在此需要使用beacon中的命令-powershell-import</p>
<pre><code>beacon&gt; help powershell-import
Use: powershell-import [/path/to/local/script.ps1]

Import a powershell script which is combined with future
calls to the powershell command. You may only use one
imported script at a time.
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1djJK"><img src="https://s2.ax1x.com/2019/07/29/e1djJK.png" alt="e1djJK.png"></a><br>使用 powershell-import 本地导入我们的脚本，powershell执行,PowerUp.ps1 这个模块是个提权辅助模块<br>下载链接:<a target="_blank" rel="noopener" href="https://github.com/HarmJ0y/PowerUp">https://github.com/HarmJ0y/PowerUp</a></p>
<h2 id="0x002-横向移动"><a href="#0x002-横向移动" class="headerlink" title="0x002-横向移动"></a>0x002-横向移动</h2><h3 id="横向渗透概念"><a href="#横向渗透概念" class="headerlink" title="横向渗透概念:"></a>横向渗透概念:</h3><p>横向渗透攻击技术是复杂网络攻击中广泛使用的一种技术，特别是在高级持续威胁（Advanced Persistent Threats，APT）中更加热衷于使用这种攻击方法。攻击者可以利用这些技术，以被攻陷的系统为跳板，访问其他主机，获取包括邮箱、共享文件夹或者凭证信息在内的敏感资源。攻击者可以利用这些敏感信息，进一步控制其他系统、提升权限或窃取更多有价值的凭证。借助此类攻击，攻击者最终可能获取域控的访问权限，完全控制基于Windows系统的基础设施或与业务相关的关键账户。<br>在提权后，我们可以用mimikatz dump目标机的凭证，并进行内网横向移动</p>
<h3 id="1-Psexec横向移动"><a href="#1-Psexec横向移动" class="headerlink" title="1.Psexec横向移动"></a>1.Psexec横向移动</h3><p>在执行端口扫描后<br>目标视图中，选择一个目标，右键–&gt;登录–p**ec，即可选择凭证进行横向移动<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1dXi6"><img src="https://s2.ax1x.com/2019/07/29/e1dXi6.png" alt="e1dXi6.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1dvRO"><img src="https://s2.ax1x.com/2019/07/29/e1dvRO.png" alt="e1dvRO.png"></a></p>
<p>如果该机使用了和之前的目标机一样的凭证，则会成功返回一个system beacon<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1wpsH"><img src="https://s2.ax1x.com/2019/07/29/e1wpsH.png" alt="e1wpsH.png"></a></p>
<h3 id="2-窃取令牌"><a href="#2-窃取令牌" class="headerlink" title="2.窃取令牌"></a>2.窃取令牌</h3><p>在进程列表中，寻找以域管理员身份运行的进程，并选定进行steal token，如果成功，则会返回域管权限的beacon，但是一般情况下绝不会那么简单的…在此就不演示了。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1dxzD"><img src="https://s2.ax1x.com/2019/07/29/e1dxzD.png" alt="e1dxzD.png"></a></p>
<h3 id="3-其他手段横向移动"><a href="#3-其他手段横向移动" class="headerlink" title="3.其他手段横向移动"></a>3.其他手段横向移动</h3><p>①使用各种系统漏洞:比如说用ms17-010，ms08-067批量检测一下内网~<br>我之前的帖子发过cobaltstrike中ms17-10的利用脚本，貌似是从Empire框架上拔下来的。如图，该脚本集成了扫描与漏洞利用，可谓是非常方便<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e1w9Ld"><img src="https://s2.ax1x.com/2019/07/29/e1w9Ld.png" alt="e1w9Ld.png"></a><br>PS:等到cve2019-0708一出，又是一场腥风血雨</p>
<p>②弱口令检测<br>内网中ssh弱口令，各种数据库的弱口令可谓是层出不穷。Mysql可以mof提权，sqlserver可以xp_cmdshell,redis写shell，oracle也有方法执行系统命令。</p>
<p>③中间件漏洞<br>这个就非常常见了，比如weblogic各种rce漏洞，tomcat弱口令等等</p>
<p>④Web端漏洞<br>挖掘web端漏洞，大家都懂</p>
<p>⑤域内漏洞<br>委派、域内权限策略配置问题等</p>
<p>⑤密码爆破、喷洒等</p>
<p>大家自行总结~</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2019/06/20/Cobaltstrike%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B-%E5%8D%81%E4%BA%8C-CS%E4%B8%8EMSF-Armitage-Empire%E4%BC%9A%E8%AF%9D%E4%BA%92%E8%BD%AC/" title="Cobaltstrike系列教程(十二)CS与MSF,Armitage,Empire会话互转"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: Cobaltstrike系列教程(十二)CS与MSF,Armitage,Empire会话互转</span></a><a class="button is-default" href="/2019/06/16/Cobaltstrike%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B-%E5%8D%81-%E5%AE%89%E8%A3%85%E6%89%A9%E5%B1%95/" title="Cobaltstrike系列教程(十)安装扩展"><span class="has-text-weight-semibold">下一页: Cobaltstrike系列教程(十)安装扩展</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="j0o1ey/j0o1ey.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/j0o1ey"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> J0o1ey 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>